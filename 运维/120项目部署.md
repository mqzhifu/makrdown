# 120项目部署

## 安装MYSQL 5.7

下载镜像 ：

> docker pull mysql:5.7

mkdir /data/docker/mysql57/conf

mkdir /data/docker/mysql57/data

mkdir /data/docker/mysql57/log

首次启动：

docker run \-d \-p 3306:3306 \-\-name ckMysq57 

\-\-privileged=true 

\-v /data/docker/mysql57/conf:/etc/mysql/mysql.conf.d 

\-v /data/docker/mysql57/log:/var/log/ 

\-v /data/docker/mysql57/data:/var/lib/mysql 

\-e MYSQL\_USER="ckck" \-e MYSQL\_PASSWORD="123456" 

\-e MYSQL\_ROOT\_PASSWORD="123456" 

\-e \-\-character\-set\-server=utf8 

\-e \-\-collation\-server=utf8\_general\_ci 

mysql:5.7

如果启动失败：

> docker logs XXXX

安装成功后，要导入初始数据：文件 seed\_pre.sql

先得创建一个数据库

> 数据库名：你们起吧，记得跟项目的配置文件同步即可。

## 安装 redis5

下载镜像：

> docker pull redis:5.0.3

创建挂载目录：

> mkdir \-p /data/docker/redis

创建配置文件:

> touch /data/docker/redis/redis.conf

```
loglevel notice
requirepass 123456
```

这里不用挂载了，直接启动：

> docker run \-d \-\-name ckRedis5 \-p 6379:6379
> 
> 
> redis:5.0.3 \-\-requirepass 333222

挂载式启动

> docker run \-d \-\-name ckRedis5 \-p 6379:6379
> 
> 
> \-v /data/docker/redis/redis.conf:/etc/redis/redis.conf
> 
> 
> redis:5.0.3

## 部署后端项目

最好先登陆，不然 docker build 会出错:

> docker login

代码在文件夹中找一下

```
#golang 编译环境
FROM golang:1.18-alpine AS builder

#使用 alpine-OS ，可以减少镜像大小。但是 alpine 默认的源在国内访问不了，需要修改为国内的源
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

#给 OS 安装 GOLANG 编译时，需要的类库: gcc 等
RUN apk add build-base

#设置代码的工作目录，容器启动直接进入此目录
WORKDIR /app

#下载代码
#RUN git clone https://github.com/xxxx/xxxxx.git;rm -rf .git;

#将代码统一复制项目代码中
COPY . .

#下载 goland 依赖包
RUN go env -w GO111MODULE=on;go env -w GOPROXY=https://goproxy.cn,direct;go mod tidy;

#帮助文档
#RUN go install github.com/swaggo/swag/cmd/swag@v1.7.9;
#RUN /go/bin/swag init --parseDependency --parseInternal --parseDepth 3;

#编译项目代码
RUN go build -ldflags  "-X main.BuildGitVersion='f65cf33ef605' -X main.BuildTime='$(date +%y%m%d)' "  -o zgoframe
#RUN go build -o zgoframe

#二阶段部署，上面阶段如果直接运行，镜像大概是：1.5GB，使用 alpine-runner 更小:100MB 以下
FROM alpine AS runner
WORKDIR /app
#COPY . .
#COPY static ./static
#COPY protobuf ./protobuf
#如果走挂载模式，这个可以不执行
COPY config/config.toml config/config.toml
COPY --from=builder /app/zgoframe .

#开放的端口号，注：这里需要看一下项目中的配置文件，要保持一致
EXPOSE 3333 5555

#CMD [ "top"]
#CMD [ "./zgoframe","-e","5"]
CMD [ "./zgoframe","-e","5","-bs","on"]

```

开始创建镜像

> docker build \-t zgoframe:0.1 .

宿主机创建配置文件：

> mkdir /data/docker/zgoframe/config
> 
> 
> cp config.toml /data/docker/zgoframe/config

执行镜像

> docker run \-d \-\-link=ckMysq57:myDb \-\-link=ckRedis5:myRedis \-v /data/docker/zgoframe/config:/app/config \-\-name myZgoframe zgoframe:0.10

进到容器里看看

> docker exec \-it 4ea6d72da1d9 /bin/sh

> 查看错误
> 
> 
> docker logs xxxxx

## 部署前端项目

http://192.168.1.22:40080/frontend/digitaltwin.git

具体找一下孙华为

## nginx/域名配置

前端\(vue\)：

```
server {
    listen       80;
    server_name  xxxx.baidu.com;

    listen 443 ssl;
    ssl_certificate /data/www/http_cert/xxx.baidu.com.pem;
    ssl_certificate_key /data/www/http_cert/120-test-xxx.baidu.com.key;

    root /data/www/120-test-web/dist;
    index index.html index.htm;

    location / {
                try_files $uri $uri/ /index.html;
    }
}
```

后端\(golang\):

```
server {
    listen       80;
    server_name  xxx.baidu.com.com;

    listen 443 ssl;
    ssl_certificate /data/www/http_cert/xxx.baidu.com.com.pem;
    ssl_certificate_key /data/www/http_cert/xxx.baidu.com.com.key;

    location /ws{

        proxy_pass http://127.0.0.1:5555/ws;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_set_header X-NginX-Proxy true;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_connect_timeout 600s;
        proxy_read_timeout 600;
        proxy_send_timeout 600s;

    }

    location / {

        proxy_set_header  X-Real-IP $remote_addr;
        proxy_set_header  REMOTE-HOST $remote_addr;
        proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_pass http://127.0.0.1:3333;

        proxy_connect_timeout 30;
        proxy_send_timeout 60;
        proxy_read_timeout 60;

    }

}
```

%E5%AE%89%E8%A3%85MYSQL%205.7%0A\-\-\-%0A%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%20%EF%BC%9A%0A%3Edocker%20pull%20mysql%3A5.7%0A%0Amkdir%20%2Fdata%2Fdocker%2Fmysql57%2Fconf%0Amkdir%20%2Fdata%2Fdocker%2Fmysql57%2Fdata%0Amkdir%20%2Fdata%2Fdocker%2Fmysql57%2Flog%0A%0A%E9%A6%96%E6%AC%A1%E5%90%AF%E5%8A%A8%EF%BC%9A%0A%0Adocker%20run%20\-d%20\-p%203306%3A3306%20\-\-name%20ckMysq57%20%20%20%5C%0A\-\-privileged%3Dtrue%20%20%5C%0A\-v%20%2Fdata%2Fdocker%2Fmysql57%2Fconf%3A%2Fetc%2Fmysql%2Fmysql.conf.d%20%5C%0A\-v%20%2Fdata%2Fdocker%2Fmysql57%2Flog%3A%2Fvar%2Flog%2F%20%5C%0A\-v%20%2Fdata%2Fdocker%2Fmysql57%2Fdata%3A%2Fvar%2Flib%2Fmysql%20%5C%0A\-e%20MYSQL\_USER%3D%22ckck%22%20\-e%20MYSQL\_PASSWORD%3D%22123456%22%20%5C%0A\-e%20MYSQL\_ROOT\_PASSWORD%3D%22123456%22%20%20%5C%0A\-e%20\-\-character\-set\-server%3Dutf8%20%5C%0A\-e%20\-\-collation\-server%3Dutf8\_general\_ci%20%5C%0Amysql%3A5.7%20%0A%0A%E5%A6%82%E6%9E%9C%E5%90%AF%E5%8A%A8%E5%A4%B1%E8%B4%A5%EF%BC%9A%0A%3Edocker%20logs%20XXXX%0A%CE%A9%0A%0A%E5%AE%89%E8%A3%85%E6%88%90%E5%8A%9F%E5%90%8E%EF%BC%8C%E8%A6%81%E5%AF%BC%E5%85%A5%E5%88%9D%E5%A7%8B%E6%95%B0%E6%8D%AE%EF%BC%9A%E6%96%87%E4%BB%B6%20seed\_pre.sql%0A%0A%E5%85%88%E5%BE%97%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%0A%3E%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8D%EF%BC%9A%E4%BD%A0%E4%BB%AC%E8%B5%B7%E5%90%A7%EF%BC%8C%E8%AE%B0%E5%BE%97%E8%B7%9F%E9%A1%B9%E7%9B%AE%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5%E5%8D%B3%E5%8F%AF%E3%80%82%0A%0A%0A%E5%AE%89%E8%A3%85%20redis5%0A\-\-\-\-%0A%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%EF%BC%9A%0A%3Edocker%20pull%20redis%3A5.0.3%0A%0A%E5%88%9B%E5%BB%BA%E6%8C%82%E8%BD%BD%E7%9B%AE%E5%BD%95%EF%BC%9A%0A%3Emkdir%20\-p%20%2Fdata%2Fdocker%2Fredis%0A%0A%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%3A%0A%3Etouch%20%2Fdata%2Fdocker%2Fredis%2Fredis.conf%0A%60%60%60%0Aloglevel%20notice%0Arequirepass%20123456%0A%60%60%60%0A%0A%E8%BF%99%E9%87%8C%E4%B8%8D%E7%94%A8%E6%8C%82%E8%BD%BD%E4%BA%86%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%90%AF%E5%8A%A8%EF%BC%9A%0A%3Edocker%20run%20\-d%20\-\-name%20ckRedis5%20\-p%206379%3A6379%20%5C%0Aredis%3A5.0.3%20%20\-\-requirepass%20333222%0A%0A%E6%8C%82%E8%BD%BD%E5%BC%8F%E5%90%AF%E5%8A%A8%0A%3Edocker%20run%20\-d%20\-\-name%20ckRedis5%20\-p%206379%3A6379%20%20%5C%0A\-v%20%2Fdata%2Fdocker%2Fredis%2Fredis.conf%3A%2Fetc%2Fredis%2Fredis.conf%20%5C%0Aredis%3A5.0.3%20%0A%0A%0A%E9%83%A8%E7%BD%B2%E5%90%8E%E7%AB%AF%E9%A1%B9%E7%9B%AE%0A\-\-\-\-%0A%E6%9C%80%E5%A5%BD%E5%85%88%E7%99%BB%E9%99%86%EF%BC%8C%E4%B8%8D%E7%84%B6%20docker%20build%20%E4%BC%9A%E5%87%BA%E9%94%99%3A%0A%3Edocker%20login%0A%0A%E4%BB%A3%E7%A0%81%E5%9C%A8%E6%96%87%E4%BB%B6%E5%A4%B9%E4%B8%AD%E6%89%BE%E4%B8%80%E4%B8%8B%0A%0A%60%60%60%0A%23golang%20%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%0AFROM%20golang%3A1.18\-alpine%20AS%20builder%0A%0A%23%E4%BD%BF%E7%94%A8%20alpine\-OS%20%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%87%8F%E5%B0%91%E9%95%9C%E5%83%8F%E5%A4%A7%E5%B0%8F%E3%80%82%E4%BD%86%E6%98%AF%20alpine%20%E9%BB%98%E8%AE%A4%E7%9A%84%E6%BA%90%E5%9C%A8%E5%9B%BD%E5%86%85%E8%AE%BF%E9%97%AE%E4%B8%8D%E4%BA%86%EF%BC%8C%E9%9C%80%E8%A6%81%E4%BF%AE%E6%94%B9%E4%B8%BA%E5%9B%BD%E5%86%85%E7%9A%84%E6%BA%90%0ARUN%20sed%20\-i%20's%2Fdl\-cdn.alpinelinux.org%2Fmirrors.aliyun.com%2Fg'%20%2Fetc%2Fapk%2Frepositories%0A%0A%23%E7%BB%99%20OS%20%E5%AE%89%E8%A3%85%20GOLANG%20%E7%BC%96%E8%AF%91%E6%97%B6%EF%BC%8C%E9%9C%80%E8%A6%81%E7%9A%84%E7%B1%BB%E5%BA%93%3A%20gcc%20%E7%AD%89%0ARUN%20apk%20add%20build\-base%0A%0A%23%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%A0%81%E7%9A%84%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%EF%BC%8C%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E7%9B%B4%E6%8E%A5%E8%BF%9B%E5%85%A5%E6%AD%A4%E7%9B%AE%E5%BD%95%0AWORKDIR%20%2Fapp%0A%0A%23%E4%B8%8B%E8%BD%BD%E4%BB%A3%E7%A0%81%0A%23RUN%20git%20clone%20https%3A%2F%2Fgithub.com%2Fxxxx%2Fxxxxx.git%3Brm%20\-rf%20.git%3B%0A%0A%23%E5%B0%86%E4%BB%A3%E7%A0%81%E7%BB%9F%E4%B8%80%E5%A4%8D%E5%88%B6%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81%E4%B8%AD%0ACOPY%20.%20.%0A%0A%23%E4%B8%8B%E8%BD%BD%20goland%20%E4%BE%9D%E8%B5%96%E5%8C%85%0ARUN%20go%20env%20\-w%20GO111MODULE%3Don%3Bgo%20env%20\-w%20GOPROXY%3Dhttps%3A%2F%2Fgoproxy.cn%2Cdirect%3Bgo%20mod%20tidy%3B%0A%0A%23%E5%B8%AE%E5%8A%A9%E6%96%87%E6%A1%A3%0A%23RUN%20go%20install%20github.com%2Fswaggo%2Fswag%2Fcmd%2Fswag%40v1.7.9%3B%0A%23RUN%20%2Fgo%2Fbin%2Fswag%20init%20\-\-parseDependency%20\-\-parseInternal%20\-\-parseDepth%203%3B%0A%0A%23%E7%BC%96%E8%AF%91%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81%0ARUN%20go%20build%20\-ldflags%20%20%22\-X%20main.BuildGitVersion%3D'f65cf33ef605'%20\-X%20main.BuildTime%3D'%24\(date%20%2B%25y%25m%25d\)'%20%22%20%20\-o%20zgoframe%0A%23RUN%20go%20build%20\-o%20zgoframe%0A%0A%23%E4%BA%8C%E9%98%B6%E6%AE%B5%E9%83%A8%E7%BD%B2%EF%BC%8C%E4%B8%8A%E9%9D%A2%E9%98%B6%E6%AE%B5%E5%A6%82%E6%9E%9C%E7%9B%B4%E6%8E%A5%E8%BF%90%E8%A1%8C%EF%BC%8C%E9%95%9C%E5%83%8F%E5%A4%A7%E6%A6%82%E6%98%AF%EF%BC%9A1.5GB%EF%BC%8C%E4%BD%BF%E7%94%A8%20alpine\-runner%20%E6%9B%B4%E5%B0%8F%3A100MB%20%E4%BB%A5%E4%B8%8B%0AFROM%20alpine%20AS%20runner%0AWORKDIR%20%2Fapp%0A%23COPY%20.%20.%0A%23COPY%20static%20.%2Fstatic%0A%23COPY%20protobuf%20.%2Fprotobuf%0A%23%E5%A6%82%E6%9E%9C%E8%B5%B0%E6%8C%82%E8%BD%BD%E6%A8%A1%E5%BC%8F%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%8F%AF%E4%BB%A5%E4%B8%8D%E6%89%A7%E8%A1%8C%0ACOPY%20config%2Fconfig.toml%20config%2Fconfig.toml%0ACOPY%20\-\-from%3Dbuilder%20%2Fapp%2Fzgoframe%20.%0A%0A%0A%23%E5%BC%80%E6%94%BE%E7%9A%84%E7%AB%AF%E5%8F%A3%E5%8F%B7%EF%BC%8C%E6%B3%A8%EF%BC%9A%E8%BF%99%E9%87%8C%E9%9C%80%E8%A6%81%E7%9C%8B%E4%B8%80%E4%B8%8B%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%8C%E8%A6%81%E4%BF%9D%E6%8C%81%E4%B8%80%E8%87%B4%0AEXPOSE%203333%205555%0A%0A%23CMD%20%5B%20%22top%22%5D%0A%23CMD%20%5B%20%22.%2Fzgoframe%22%2C%22\-e%22%2C%225%22%5D%0ACMD%20%5B%20%22.%2Fzgoframe%22%2C%22\-e%22%2C%225%22%2C%22\-bs%22%2C%22on%22%5D%0A%0A%60%60%60%0A%0A%E5%BC%80%E5%A7%8B%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%0A%3Edocker%20build%20\-t%20zgoframe%3A0.1%20.%0A%0A%E5%AE%BF%E4%B8%BB%E6%9C%BA%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%9A%0A%3Emkdir%20%2Fdata%2Fdocker%2Fzgoframe%2Fconfig%0A%3Ecp%20config.toml%20%2Fdata%2Fdocker%2Fzgoframe%2Fconfig%0A%0A%E6%89%A7%E8%A1%8C%E9%95%9C%E5%83%8F%0A%3Edocker%20run%20\-d%20\-\-link%3DckMysq57%3AmyDb%20\-\-link%3DckRedis5%3AmyRedis%20\-v%20%2Fdata%2Fdocker%2Fzgoframe%2Fconfig%3A%2Fapp%2Fconfig%20\-\-name%20myZgoframe%20zgoframe%3A0.10%0A%0A%E8%BF%9B%E5%88%B0%E5%AE%B9%E5%99%A8%E9%87%8C%E7%9C%8B%E7%9C%8B%0A%3Edocker%20exec%20\-it%20%204ea6d72da1d9%20%2Fbin%2Fsh%0A%0A%3E%E6%9F%A5%E7%9C%8B%E9%94%99%E8%AF%AF%20%0Adocker%20logs%20xxxxx%0A%0A%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%0A\-\-\-\-\-%0Ahttp%3A%2F%2F192.168.1.22%3A40080%2Ffrontend%2Fdigitaltwin.git%0A%0A%E5%85%B7%E4%BD%93%E6%89%BE%E4%B8%80%E4%B8%8B%E5%AD%99%E5%8D%8E%E4%B8%BA%0A%0A%0Anginx%2F%E5%9F%9F%E5%90%8D%E9%85%8D%E7%BD%AE%0A\-\-\-%0A%E5%89%8D%E7%AB%AF\(vue\)%EF%BC%9A%0A%60%60%60%0Aserver%20%7B%0A%20%20%20%20listen%20%20%20%20%20%20%2080%3B%0A%20%20%20%20server\_name%20%20xxxx.baidu.com%3B%0A%0A%20%20%20%20listen%20443%20ssl%3B%0A%20%20%20%20ssl\_certificate%20%2Fdata%2Fwww%2Fhttp\_cert%2Fxxx.baidu.com.pem%3B%0A%20%20%20%20ssl\_certificate\_key%20%2Fdata%2Fwww%2Fhttp\_cert%2F120\-test\-xxx.baidu.com.key%3B%0A%0A%20%20%20%20root%20%2Fdata%2Fwww%2F120\-test\-web%2Fdist%3B%0A%20%20%20%20index%20index.html%20index.htm%3B%0A%0A%20%20%20%20location%20%2F%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20try\_files%20%24uri%20%24uri%2F%20%2Findex.html%3B%0A%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%E5%90%8E%E7%AB%AF\(golang\)%3A%0A%60%60%60%0Aserver%20%7B%0A%20%20%20%20listen%20%20%20%20%20%20%2080%3B%0A%20%20%20%20server\_name%20%20xxx.baidu.com.com%3B%0A%0A%20%20%20%20listen%20443%20ssl%3B%0A%20%20%20%20ssl\_certificate%20%2Fdata%2Fwww%2Fhttp\_cert%2Fxxx.baidu.com.com.pem%3B%0A%20%20%20%20ssl\_certificate\_key%20%2Fdata%2Fwww%2Fhttp\_cert%2Fxxx.baidu.com.com.key%3B%0A%0A%20%20%20%20location%20%2Fws%7B%0A%0A%20%20%20%20%20%20%20%20proxy\_pass%20http%3A%2F%2F127.0.0.1%3A5555%2Fws%3B%0A%0A%20%20%20%20%20%20%20%20proxy\_set\_header%20X\-Real\-IP%20%24remote\_addr%3B%0A%20%20%20%20%20%20%20%20proxy\_set\_header%20X\-Forwarded\-For%20%24proxy\_add\_x\_forwarded\_for%3B%0A%20%20%20%20%20%20%20%20proxy\_set\_header%20Host%20%24host%3B%0A%20%20%20%20%20%20%20%20proxy\_set\_header%20X\-NginX\-Proxy%20true%3B%0A%20%20%20%20%20%20%20%20proxy\_http\_version%201.1%3B%0A%20%20%20%20%20%20%20%20proxy\_set\_header%20Upgrade%20%24http\_upgrade%3B%0A%20%20%20%20%20%20%20%20proxy\_set\_header%20Connection%20%22Upgrade%22%3B%0A%20%20%20%20%20%20%20%20proxy\_connect\_timeout%20600s%3B%0A%20%20%20%20%20%20%20%20proxy\_read\_timeout%20600%3B%0A%20%20%20%20%20%20%20%20proxy\_send\_timeout%20600s%3B%0A%0A%0A%20%20%20%20%7D%0A%0A%0A%0A%20%20%20%20location%20%2F%20%7B%0A%0A%20%20%20%20%20%20%20%20proxy\_set\_header%20%20X\-Real\-IP%20%24remote\_addr%3B%0A%20%20%20%20%20%20%20%20proxy\_set\_header%20%20REMOTE\-HOST%20%24remote\_addr%3B%0A%20%20%20%20%20%20%20%20proxy\_set\_header%20%20X\-Forwarded\-For%20%24proxy\_add\_x\_forwarded\_for%3B%0A%0A%0A%20%20%20%20%20%20%20%20proxy\_pass%20http%3A%2F%2F127.0.0.1%3A3333%3B%0A%0A%20%20%20%20%20%20%20%20proxy\_connect\_timeout%2030%3B%0A%20%20%20%20%20%20%20%20proxy\_send\_timeout%2060%3B%0A%20%20%20%20%20%20%20%20proxy\_read\_timeout%2060%3B%0A%0A%20%20%20%20%7D%0A%0A%7D%0A%60%60%60
