# 目标

party\-game项目中，有一个中台系统，是自研，分析下，是否能迁移过来，并搭建起来，实现复用

## 产品文档PRD：

https://kxleqzb9u6.feishu.cn/docs/doccnwSzzLFTgf6ikk9Z3Pa0vbg

## 梳理项目

项目整体上分成两个部分

1. 游戏：UNITY前端\+UNITY后端
2. 中台系统

unity端基本上代码没有碰，无法迁移，所以 ，重点是第2条：中台

中台，先从从GIT项目仓看，如下几个：

1. 匹配
    http://192.168.1.22:40080/service/partygame/gamematch
2. 后台管理\-后端
    http://192.168.1.22:40080/service/partygame/adminserver.git
3. 后台管理\-前端
    http://192.168.1.22:40080/service/partygame/adminweb.git
4. 基础服务中心，如：用户中心、任务、成就、站内信等，都是短连接
    http://192.168.1.22:40080/service/partygame/accountserver.git
5. 房间服务/消息中心，接收UNITY后端发送的mqtt消息，创建房间，与匹配服务进行通信
    http://192.168.1.22:40080/service/partygame/msgServer.git

> 其中2和3，是可以合成一个项目的，所以，最大的方向看，一共是4个微服务

中台，从功能模块上看，大体分成如下几块：

1. Room：房间服务/大厅服务，长连接\(与unity后端通信\)，使用的mqtt协议及管理软件，主要功能：组队、mqtt长连接、IM消息收发
2. 匹配：对玩家进行分组匹配，主要与room通信
3. 帧同步：长连接，对玩家在一局游戏的动作、释放技能等同步，（简单的囚徒锁模式）
4. 管理后台：管理整个游戏的：配置信息、用户信息、黑词、举报、认识、基础统计、订单统计等，辅助完成日常运营 。node \+ vue \+ go
5. 用户中心：注册/登陆/、任务、邮件\(站内信\)、道具、成就、好友、粉丝、订单、支付、货币消耗、存档、站内信等

结合看，以上就是需要迁移的所有模块\(代码\)

用到的语言：GO\+VUE

用到的开源软件：emqtt\+redis\+mysql\+etcd

## 咪咕

测试环境\-IP

> 114.116.212.202

admin URL

> http://114.116.212.202/admin/ui/\#/login

swag:

> http://114.116.212.202/account/dev/swagger/index.html\#/%E7%B3%BB%E7%BB%9F/post\_v1\_sys\_addJewel

项目提交测试：

```
scp -r adminserver  root@114.116.212.202:/www/git_project
scp -r  accountserver  root@114.116.212.202:/www/git_project
go build -o accountServer
```

## 迁移流程

1. github上创建版本库，并将代码上传至新的版本库中
2. 本地安装与测试
    1. 将原代码clone后，转至新的库中，并提交
    2. 依赖软件\(开源\)安装: MYSQL REDIS E\-MQTT GO NODE NPM ETCD
    3. 创建数据库、表，并初始化基数据
    4. 初始化etcd基数据
    5. 启动运行程度，调试代码
    6. 日志存储目录配置、配置文件创建并修改
    7. 记录调试过程
3. 测试环境搭建
    1. 确定服务器
    2. 确定域名
    3. 重复步骤2

## gitlab创建过程

在gitlab上创建好组，将几个项目统一放置于一个目录下

# 开始迁移

## 匹配服务

Git url:

> http://192.168.1.22:40080/service/partygame/gamematch

脚本启动指令：

> go run main.go dev /data/www/golang/src/service/partygame/logs 1023 http://127.0.0.1/etcd\_info.php

> go run main.go dev /Users/mayanyan/data/www/golang/logs 1023 http://127.0.0.1/1

参数说明：

1. 环境变量：Local dev test online
2. 日志存储目录
3. 日志级别：1 2 4 .....全部是 1023
4. 获取ETCD连接信息

先创建好日志存储目录，注：这里的目录下还需要再创建子目录:service

mkdir \-p /data/www/golang/src/service/partygame/logs/service

chmod \-R 777 /data/www/golang/src/service/partygame/logs

依赖组件：ETCD REDIS

依赖3方服务：获取\(动态\)ETCD连接地址，匹配成功推送数据

依赖配置：

1. ETCD地址，是动态获取，启动脚本的时候需要把URL地址一并写入，其返回格式如下：
    {"code":0,"data":{"username":"","password":"","hosts":\["8.142.177.235:2379"\]}}
2. ETCD里，有REDIS 的配置信息，需要提前打入
    etcdctl \-\-endpoints=127.0.0.1:2379 put /gamematch/dev/pid\_file\_path /tmp/gamematch.pid
    etcdctl \-\-endpoints=127.0.0.1:2379 put /gamematch/dev/redis\_host 8.142.177.235
    etcdctl \-\-endpoints=127.0.0.1:2379 put /gamematch/dev/redis\_port 6379
    etcdctl \-\-endpoints=8.142.177.235:2379 put /gamematch/dev/redis\_ps 1234
    etcdctl \-\-endpoints=127.0.0.1:2379 put /gamematch/dev/reg\_self\_port 5678
3. ETCD里，有后台配置好的的：匹配规则基础配置信息，需要提前打入
    etcdctl \-\-endpoints=8.142.177.235:2379 put /v1/conf/matches/test\_match\_group '{"id":6,"games\_id":68043879,"name":"1v1v1","status":1,"match\_code":"test\_match\_group","team\_type":1,"max\_players":6,"rule":"{}","rule\_ver":1,"timeout":10,"success\_timeout":20}'

etcdctl \-\-endpoints=8.142.177.235:2379 get / \-\-prefix

服务注册etcd，KEY：

/v1/service/gamematch/192.168.1.169:6789

调用3方服务etcd,key:

/v1/service/msgServer/192.168.1.169:8080

## 管理后台\-后端

> git clone http://192.168.1.22:40080/service/partygame/adminserver.git

依赖组件：ETCD REDIS MYSQL EMAIL aliyun

先导入DB，两个库 pg\_account pg\_friend

CREATE DATABASE IF NOT EXISTS pg\_account DEFAULT CHARSET utf8 COLLATE utf8\_general\_ci;

use pg\_account

source /install/pg\_account.sql

source /install/pg\_account\_data.sql

处理下视图

```
SELECT TABLE_SCHEMA, TABLE_NAME FROM information_schema.tables WHERE TABLE_TYPE LIKE 'VIEW';
authority_menu;
CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`%` SQL SECURITY DEFINER VIEW `authority_menu`  AS SELECT `sys_base_menus`.`id` AS `id`, `sys_base_menus`.`created_at` AS `created_at`, `sys_base_menus`.`updated_at` AS `updated_at`, `sys_base_menus`.`deleted_at` AS `deleted_at`, `sys_base_menus`.`menu_level` AS `menu_level`, `sys_base_menus`.`parent_id` AS `parent_id`, `sys_base_menus`.`path` AS `path`, `sys_base_menus`.`name` AS `name`, `sys_base_menus`.`hidden` AS `hidden`, `sys_base_menus`.`component` AS `component`, `sys_base_menus`.`title` AS `title`, `sys_base_menus`.`icon` AS `icon`, `sys_base_menus`.`sort` AS `sort`, `sys_authority_menus`.`sys_authority_authority_id` AS `authority_id`, `sys_authority_menus`.`sys_base_menu_id` AS `menu_id`, `sys_base_menus`.`keep_alive` AS `keep_alive`, `sys_base_menus`.`default_menu` AS `default_menu` FROM (`sys_authority_menus` join `sys_base_menus` on((`sys_authority_menus`.`sys_base_menu_id` = `sys_base_menus`.`id`))) ;
```

CREATE DATABASE IF NOT EXISTS pg\_friend DEFAULT CHARSET utf8 COLLATE utf8\_general\_ci;

use pg\_friend

source /install/pg\_friend.sql

```
cp config.toml.demo config.toml
vim config.toml
```

go run main.go

## 管理后台\-前端

> git clone http://192.168.1.22:40080/service/partygame/adminweb.git

centos:yum install xdg\-utils

//开始安装NODE依赖包\(最好是挂VPN\)

npm install \-\-unsafe\-perm=true \-\-allow\-root

启动

npm run serve

http://127.0.0.1:8080

上面是测试，上到正式环境，是将前端js打包，放到GO的项目里，统一一个项目就OK了

npm run build

cp \-r dist adminserver/resource

## account

> git clone http://192.168.1.22:40080/service/partygame/accountserver.git
> cp config.simple.toml config.toml

~/go/bin/swag init

go run main.go

## msgServer

> git clone http://192.168.1.22:40080/service/partygame/msgServer.git
> 
> 
> cp config.simple.toml config.toml

依赖 e

重连检测\-玩家离线后重新获取组队信息或重新进入组队

/battle/v1/group/reconnect/63030530

查询我所在的最新队伍信息

GET /battle/v1/group/info/63030530 HTTP/1.1

