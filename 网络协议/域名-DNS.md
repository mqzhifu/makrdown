# 域名/DNS

## 概览

域名：数字\+字母\(汉字、中横线\)\+后缀组成，不区分大小写，一个类似标识符的字符串的东西。其解决了在在互联网中，使用IP很难记的一种东西吧。最最长度是255

> www.baidu.com sing.com.cn apache.org

字符串肯定是自己申请的，后缀是死的\(机构制定，我们改不了\)，主要是给域名做个公共分类，后缀类型如下：

com：Commercial organizations,商业组织,公司

xyz：创意、创新；三维空间与无限可能

net：Network operations and service centers,网络服务商

tech：科技、技术

org：Other organizations,非盈利组织

gov：Governmental entities,政府部门

edu：Educational institutions,教研机构

cn:中国

> 世界上第一个注册的域名是在1985年1月注册的

它的整个运行机制\(核心\)是由DNS来管理/驱动的

## DNS

Domain Name System，域名系统

CANN，Internet Corporation for Assigned Names and Numbers

光有域名没用的，必须得有一个权威机构接收你的：申请/注册，且全球唯一。并且提供域名解析成IP的功能

如果全世界就一台服务器，肯定不行，所以就得牵扯到：分布式构架

![domain-tree.png](image/domain-tree.png)

#### 域名解析服务器

服务器类型分为：根、顶级域名、权限（权威）域名

根域名服务器：知道所有顶级域名的IP地址，具说是有：13个IP\(不一定是13台机器\)，它也存一些映射IP，但好像它更多的是转发到顶级域名服务器上解析

顶级域名服务器：.com .org 这些，在这些顶级域名注册的二级域名，同时保存权限域名服务器IP

权限域名服务器：负责一个区，或者是3级域名及以上。

> 感觉像是私有的，比如某公司自己可以搞一个，某个政府/国家也可以搞，跟本地域名服务器有点像呢
> 
> 
> 区好像是域的子集

> 所有服务器都必须具有一定解析IP的能力，并且能有其它服务器的地址。
> 
> 
> 任何一台服务器都不太可能存储所有的域名IP

它的查找分为2种方式：递归、迭代

下面以递归来做DEMO：

![domain-search.png](image/domain-search.png)

具体解析过程：

1. 查询本地域名解析，如果有直接返回。
    1. 浏览器缓存\(有时间限制的，根据TTL设置\)
    2. HOST文件\(黑客的最爱,简单有效，域名劫持\)
    3. 本地域名解析服务器，网卡配置文件中的，DNS\-IP（/etc/resolv.conf），黑客依然喜欢
2. 向根服务器发出请求，如果有直接返回。否则，向顶级域名发出请求
3. 顶级域名接收，如果有直接返回。否则，返回失败
4. 最终请求方接收

递归：就是请求方发出一次请求后，等待即可，剩下的是其它各域名服务器之间递归查找

迭代：请求方，发出一次，如果对方未找到IP，会附加的再给你返回下一个域名服务器的IP，请求方需要接着继续找，直接有结果

> 它的这个分布式系统，是真的够松散，会不会有死循环呢？

域名服务器提供哪些类型的服务

|关键字|解释                                                        |
|------|------------------------------------------------------------|
|A     |address, 域名指向IP\(也包括子域名\)，这个是使用最多的       |
|cname |别名，也可以成跳转，就是起个子域名跳转到A域名下             |
|mx    |绑定邮件服务器                                              |
|NS记录|name server,希望由12.34.56.78这台服务器解析news.mydomain.com|

## DNS协议

请求解析域名，是要走网络的，那就得有一个协议，DNS协议较为简单，TCP/UDP都支持，但好像UDP居多，因为它快/简单，接收方一般开的是53端口\(TCP/UDP均能接收\)

![domain-protocol.png](image/domain-protocol.png)

1. ID：16位的消息ID，标示一次正常的交互，该ID由消息请求者设置，消息响应者回复请求时带上该ID。
2. flag：16位的标志位，格式如下：
    ![domain-protocol-1.png](image/domain-protocol-1.png)
    QR：占1位，该位为0表示是查询报文，该位为1表示是响应报文
    opcode：占4位，全是0表示标准查询，全是1表示反向查询，全是2表示服务器状态请求
    AA：占1位，如果是1表示授权回答，表示该应答是否来自该域的权威服务器
    TC：占1位，如果是1表示可截断的，即使用UDP时，它表示当应答总长度超过512字节时，只返回前512字节数据
    RD：占1位，如果是1表示期望递归，可在查询中设置，并在响应中返回，该位设置为1表示使用递归查询，该位设置为0表示使用迭代查询
    RA：占1位，如果是1表示可用递归，如果名字服务器支持递归查询，可在响应中将该比特位置为1
    zero：占3位，全部必须设置为0，作为保留位
    rcode：占4位，表示返回码字段，值为0表示查询的名字没有差错，值为3表示查询的结果有名字差错（域名不存在）

ttl:Time To Live,生存周期，域名缓存

nslookup

dig
