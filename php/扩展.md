# 扩展

https://blog.csdn.net/zjuwangleicn/article/details/79528375

http://blog.sina.com.cn/s/blog\_4ee5c07b0101e1a4.html

http://www.laruence.com/2009/04/28/719.html

https://blog.csdn.net/alexdream/article/details/2213344

//c\+\+扩展

https://www.php.cn/php\-weizijiaocheng\-392511.html

cd ext

./ext\_skel \-\-extname=zdemo

cd zdemo

vim config.m4

//dnl开头的都是注释

打开

PHP\_ARG\_ENABLE\(zdemo, whether to enable zdemo support,

Make sure that the comment is aligned:

\[ \-\-enable\-zdemo Enable zdemo support\]\)

zend\_module\_entry 结构体，是对，这个扩展的描述信息，如：扩展名、大小、包含的函数，大部分是指针

上面是原结构体，接着要给这个结构体初始化了

zend\_module\_entry say\_hello\_module\_entry = {

\#if ZEND\_MODULE\_API\_NO \>= 20010901

STANDARD\_MODULE\_HEADER,

\#endif

"say\_hello",

say\_hello\_functions,

PHP\_MINIT\(say\_hello\),

PHP\_MSHUTDOWN\(say\_hello\),

PHP\_RINIT\(say\_hello\), /\* Replace with NULL if there's nothing to do at request start _/

PHP\_RSHUTDOWN\(say\_hello\), /_ Replace with NULL if there's nothing to do at request end _/

PHP\_MINFO\(say\_hello\),

\#if ZEND\_MODULE\_API\_NO \>= 20010901

"0.1", /_ Replace with version number for your extension \*/

\#endif

STANDARD\_MODULE\_PROPERTIES

};

PHP\_MINIT：模块初始化

PHP\_MSHUTDOWN：模块结束

PHP\_RINIT：PHP 初始化

PHP\_RSHUTDOWN：PHP 结束

实际上，你是在PHP上写扩展，也就是在别人的框架上写扩展，那你就得按照PHP的框架方式写，所以这里面有很多定义好的宏，好处就是 省事，不好的地方就是 不能全部裸写

PHP\_MINFO\_FUNCTION

这个函数体内，就是修改phpinfo的东西

开始正式编写函数：

先在下面的常量 \- 结构体内，增加自定义函数

const zend\_function\_entry zdemo\_functions\[\] = {

PHP\_FE\(confirm\_zdemo\_compiled, NULL\) /\* For testing, remove later. _/

PHP\_FE\(函数名，函数参数\)

PHP\_FE\_END /_ Must be the last line in zdemo\_functions\[\] \*/

};

PHP\_FE\(函数名，函数参数\)：主要是增加这一行，先跑通，再说参数的事儿

接着就是 实现体了：

找到系统自带的 confirm\_zdemo\_compiled，在下面新起一行

PHP\_FUNCTION\(函数名\)

{

php\_printf\("Hello World\!\\n"\);

RETURN\_TRUE;

}

函数名就是：你自定义的函数名。

保存，编译，执行，先看下效果

./configure && make && make install

修改php.ini 加入扩展

新建个test.php，执行看下效果，大功告成！

接着，要开始加入参数了。

PHP\_FE，增加一个新函数

增加一个 PHP\_FUNCTION

zend\_parse\_parameters 函数，接收参数

zend\_parse\_parameters\(ZEND\_NUM\_ARGS\(\) TSRMLS\_CC, "s", &arg, &arg\_len\) == FAILURE

ZEND\_NUM\_ARGS：参数个数

TSRMLS\_CC：线程安全变量

TSRM 线程安全资源管理，Thread Safe Resource Manager。当开户了线程安全，就会有ZTS\(Zend Thread Safety\)宏，这个宏是4个宏，其中包括 TSRMLS\_CC ,tsrm\_ls

第二个参数：

b Boolean

l Integer 整型

d Floating point 浮点型

s String 字符串

r Resource 资源

a Array 数组

o Object instance 对象

O Object instance of a specified type 特定类型的对象

z Non\-specific zval 任意类型～

Z zval\*\*类型

f 表示函数、方法名称，PHP5.1里貌似木有... ...

https%3A%2F%2Fblog.csdn.net%2Fzjuwangleicn%2Farticle%2Fdetails%2F79528375%0Ahttp%3A%2F%2Fblog.sina.com.cn%2Fs%2Fblog\_4ee5c07b0101e1a4.html%0Ahttp%3A%2F%2Fwww.laruence.com%2F2009%2F04%2F28%2F719.html%0Ahttps%3A%2F%2Fblog.csdn.net%2Falexdream%2Farticle%2Fdetails%2F2213344%0A%0A%2F%2Fc%2B%2B%E6%89%A9%E5%B1%95%0Ahttps%3A%2F%2Fwww.php.cn%2Fphp\-weizijiaocheng\-392511.html%0A%0Acd%20ext%0A.%2Fext\_skel%20\-\-extname%3Dzdemo%0A%0Acd%20zdemo%0Avim%20config.m4%0A%2F%2Fdnl%E5%BC%80%E5%A4%B4%E7%9A%84%E9%83%BD%E6%98%AF%E6%B3%A8%E9%87%8A%20%0A%E6%89%93%E5%BC%80%0APHP\_ARG\_ENABLE\(zdemo%2C%20whether%20to%20enable%20zdemo%20support%2C%0AMake%20sure%20that%20the%20comment%20is%20aligned%3A%0A%5B%20%20\-\-enable\-zdemo%20%20%20%20%20%20%20%20%20%20%20Enable%20zdemo%20support%5D\)%0A%0A%0A%0Azend\_module\_entry%20%20%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%8C%E6%98%AF%E5%AF%B9%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%89%A9%E5%B1%95%E7%9A%84%E6%8F%8F%E8%BF%B0%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%A6%82%EF%BC%9A%E6%89%A9%E5%B1%95%E5%90%8D%E3%80%81%E5%A4%A7%E5%B0%8F%E3%80%81%E5%8C%85%E5%90%AB%E7%9A%84%E5%87%BD%E6%95%B0%EF%BC%8C%E5%A4%A7%E9%83%A8%E5%88%86%E6%98%AF%E6%8C%87%E9%92%88%0A%0A%E4%B8%8A%E9%9D%A2%E6%98%AF%E5%8E%9F%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%8C%E6%8E%A5%E7%9D%80%E8%A6%81%E7%BB%99%E8%BF%99%E4%B8%AA%E7%BB%93%E6%9E%84%E4%BD%93%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BA%86%0Azend\_module\_entry%20say\_hello\_module\_entry%20%3D%20%7B%0A%20%20%20%20%23if%20ZEND\_MODULE\_API\_NO%20%3E%3D%2020010901%0A%20%20%20%20STANDARD\_MODULE\_HEADER%2C%0A%20%20%20%20%23endif%0A%20%20%20%20%22say\_hello%22%2C%0A%20%20%20%20say\_hello\_functions%2C%0A%20%20%20%20PHP\_MINIT\(say\_hello\)%2C%0A%20%20%20%20PHP\_MSHUTDOWN\(say\_hello\)%2C%0A%20%20%20%20PHP\_RINIT\(say\_hello\)%2C%20%2F\*%20Replace%20with%20NULL%20if%20there's%20nothing%20to%20do%20at%20request%20start%20\*%2F%0A%20%20%20%20PHP\_RSHUTDOWN\(say\_hello\)%2C%20%2F\*%20Replace%20with%20NULL%20if%20there's%20nothing%20to%20do%20at%20request%20end%20\*%2F%0A%20%20%20%20PHP\_MINFO\(say\_hello\)%2C%0A%20%20%20%20%23if%20ZEND\_MODULE\_API\_NO%20%3E%3D%2020010901%0A%20%20%20%20%220.1%22%2C%20%2F\*%20Replace%20with%20version%20number%20for%20your%20extension%20\*%2F%0A%20%20%20%20%23endif%0A%20%20%20%20STANDARD\_MODULE\_PROPERTIES%0A%7D%3B%0A%0APHP\_MINIT%EF%BC%9A%E6%A8%A1%E5%9D%97%E5%88%9D%E5%A7%8B%E5%8C%96%0APHP\_MSHUTDOWN%EF%BC%9A%E6%A8%A1%E5%9D%97%E7%BB%93%E6%9D%9F%0APHP\_RINIT%EF%BC%9APHP%20%E5%88%9D%E5%A7%8B%E5%8C%96%0APHP\_RSHUTDOWN%EF%BC%9APHP%20%E7%BB%93%E6%9D%9F%20%0A%0A%0A%E5%AE%9E%E9%99%85%E4%B8%8A%EF%BC%8C%E4%BD%A0%E6%98%AF%E5%9C%A8PHP%E4%B8%8A%E5%86%99%E6%89%A9%E5%B1%95%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E5%9C%A8%E5%88%AB%E4%BA%BA%E7%9A%84%E6%A1%86%E6%9E%B6%E4%B8%8A%E5%86%99%E6%89%A9%E5%B1%95%EF%BC%8C%E9%82%A3%E4%BD%A0%E5%B0%B1%E5%BE%97%E6%8C%89%E7%85%A7PHP%E7%9A%84%E6%A1%86%E6%9E%B6%E6%96%B9%E5%BC%8F%E5%86%99%EF%BC%8C%E6%89%80%E4%BB%A5%E8%BF%99%E9%87%8C%E9%9D%A2%E6%9C%89%E5%BE%88%E5%A4%9A%E5%AE%9A%E4%B9%89%E5%A5%BD%E7%9A%84%E5%AE%8F%EF%BC%8C%E5%A5%BD%E5%A4%84%E5%B0%B1%E6%98%AF%20%E7%9C%81%E4%BA%8B%EF%BC%8C%E4%B8%8D%E5%A5%BD%E7%9A%84%E5%9C%B0%E6%96%B9%E5%B0%B1%E6%98%AF%20%20%E4%B8%8D%E8%83%BD%E5%85%A8%E9%83%A8%E8%A3%B8%E5%86%99%0A%0APHP\_MINFO\_FUNCTION%0A%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E4%BD%93%E5%86%85%EF%BC%8C%E5%B0%B1%E6%98%AF%E4%BF%AE%E6%94%B9phpinfo%E7%9A%84%E4%B8%9C%E8%A5%BF%0A%0A%E5%BC%80%E5%A7%8B%E6%AD%A3%E5%BC%8F%E7%BC%96%E5%86%99%E5%87%BD%E6%95%B0%EF%BC%9A%0A%0A%E5%85%88%E5%9C%A8%E4%B8%8B%E9%9D%A2%E7%9A%84%E5%B8%B8%E9%87%8F%20%20\-%20%E7%BB%93%E6%9E%84%E4%BD%93%E5%86%85%EF%BC%8C%E5%A2%9E%E5%8A%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0%0A%0Aconst%20zend\_function\_entry%20zdemo\_functions%5B%5D%20%3D%20%7B%0A%20%20%20%20%20%20%20%20PHP\_FE\(confirm\_zdemo\_compiled%2C%20%20NULL\)%20%20%20%20%20%20%20%20%20%20%20%2F\*%20For%20testing%2C%20remove%20later.%20\*%2F%0APHP\_FE\(%E5%87%BD%E6%95%B0%E5%90%8D%EF%BC%8C%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0\)%0A%20%20%20%20%20%20%20%20PHP\_FE\_END%20%20%20%20%20%20%2F\*%20Must%20be%20the%20last%20line%20in%20zdemo\_functions%5B%5D%20\*%2F%0A%7D%3B%0A%0APHP\_FE\(%E5%87%BD%E6%95%B0%E5%90%8D%EF%BC%8C%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0\)%EF%BC%9A%E4%B8%BB%E8%A6%81%E6%98%AF%E5%A2%9E%E5%8A%A0%E8%BF%99%E4%B8%80%E8%A1%8C%EF%BC%8C%E5%85%88%E8%B7%91%E9%80%9A%EF%BC%8C%E5%86%8D%E8%AF%B4%E5%8F%82%E6%95%B0%E7%9A%84%E4%BA%8B%E5%84%BF%0A%0A%E6%8E%A5%E7%9D%80%E5%B0%B1%E6%98%AF%20%E5%AE%9E%E7%8E%B0%E4%BD%93%E4%BA%86%EF%BC%9A%0A%0A%E6%89%BE%E5%88%B0%E7%B3%BB%E7%BB%9F%E8%87%AA%E5%B8%A6%E7%9A%84%20%20confirm\_zdemo\_compiled%EF%BC%8C%E5%9C%A8%E4%B8%8B%E9%9D%A2%E6%96%B0%E8%B5%B7%E4%B8%80%E8%A1%8C%0A%0APHP\_FUNCTION\(%E5%87%BD%E6%95%B0%E5%90%8D\)%0A%7B%0A%20%20%20%20%20%20%20%20php\_printf\(%22Hello%20World\!%5Cn%22\)%3B%0A%20%20%20%20%20%20%20%20RETURN\_TRUE%3B%0A%7D%0A%0A%E5%87%BD%E6%95%B0%E5%90%8D%E5%B0%B1%E6%98%AF%EF%BC%9A%E4%BD%A0%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E5%87%BD%E6%95%B0%E5%90%8D%E3%80%82%0A%0A%E4%BF%9D%E5%AD%98%EF%BC%8C%E7%BC%96%E8%AF%91%EF%BC%8C%E6%89%A7%E8%A1%8C%EF%BC%8C%E5%85%88%E7%9C%8B%E4%B8%8B%E6%95%88%E6%9E%9C%0A.%2Fconfigure%20%26%26%20make%20%26%26%20make%20install%20%20%20%0A%E4%BF%AE%E6%94%B9php.ini%20%E5%8A%A0%E5%85%A5%E6%89%A9%E5%B1%95%0A%0A%E6%96%B0%E5%BB%BA%E4%B8%AAtest.php%EF%BC%8C%E6%89%A7%E8%A1%8C%E7%9C%8B%E4%B8%8B%E6%95%88%E6%9E%9C%EF%BC%8C%E5%A4%A7%E5%8A%9F%E5%91%8A%E6%88%90%EF%BC%81%0A%0A%E6%8E%A5%E7%9D%80%EF%BC%8C%E8%A6%81%E5%BC%80%E5%A7%8B%E5%8A%A0%E5%85%A5%E5%8F%82%E6%95%B0%E4%BA%86%E3%80%82%0A%0APHP\_FE%EF%BC%8C%E5%A2%9E%E5%8A%A0%E4%B8%80%E4%B8%AA%E6%96%B0%E5%87%BD%E6%95%B0%0A%E5%A2%9E%E5%8A%A0%E4%B8%80%E4%B8%AA%20PHP\_FUNCTION%20%0A%0A%0Azend\_parse\_parameters%20%20%E5%87%BD%E6%95%B0%EF%BC%8C%E6%8E%A5%E6%94%B6%E5%8F%82%E6%95%B0%0Azend\_parse\_parameters\(ZEND\_NUM\_ARGS\(\)%20TSRMLS\_CC%2C%20%22s%22%2C%20%26arg%2C%20%26arg\_len\)%20%3D%3D%20FAILURE%0A%0A%0AZEND\_NUM\_ARGS%EF%BC%9A%E5%8F%82%E6%95%B0%E4%B8%AA%E6%95%B0%0A%0A%0ATSRMLS\_CC%EF%BC%9A%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E5%8F%98%E9%87%8F%0ATSRM%20%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%EF%BC%8CThread%20Safe%20Resource%20Manager%E3%80%82%E5%BD%93%E5%BC%80%E6%88%B7%E4%BA%86%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%EF%BC%8C%E5%B0%B1%E4%BC%9A%E6%9C%89ZTS\(Zend%20Thread%20Safety\)%E5%AE%8F%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%AE%8F%E6%98%AF4%E4%B8%AA%E5%AE%8F%EF%BC%8C%E5%85%B6%E4%B8%AD%E5%8C%85%E6%8B%AC%20%20%20%20%09TSRMLS\_CC%20%2Ctsrm\_ls%0A%0A%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%EF%BC%9A%0A%0Ab%20%20%20Boolean%0Al%20%20%20Integer%20%E6%95%B4%E5%9E%8B%0Ad%20%20%20Floating%20point%20%E6%B5%AE%E7%82%B9%E5%9E%8B%0As%20%20%20String%20%E5%AD%97%E7%AC%A6%E4%B8%B2%0Ar%20%20%20Resource%20%E8%B5%84%E6%BA%90%0Aa%20%20%20Array%20%E6%95%B0%E7%BB%84%0Ao%20%20%20Object%20instance%20%E5%AF%B9%E8%B1%A1%0AO%20%20%20Object%20instance%20of%20a%20specified%20type%20%E7%89%B9%E5%AE%9A%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%AF%B9%E8%B1%A1%0Az%20%20%20Non\-specific%20zval%20%E4%BB%BB%E6%84%8F%E7%B1%BB%E5%9E%8B%EF%BD%9E%0AZ%20%20%20zval\*\*%E7%B1%BB%E5%9E%8B%0Af%20%20%20%E8%A1%A8%E7%A4%BA%E5%87%BD%E6%95%B0%E3%80%81%E6%96%B9%E6%B3%95%E5%90%8D%E7%A7%B0%EF%BC%8CPHP5.1%E9%87%8C%E8%B2%8C%E4%BC%BC%E6%9C%A8%E6%9C%89...%20...%0A%0A%0A%0A%0A%0A%0A%0A%0A%0A
