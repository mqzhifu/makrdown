# chan

先上源码

> go/src/runtime/chan.go

```
type hchan struct {
	qcount   uint           // 队列中的元素总量
	dataqsiz uint           // 缓冲大小，=make(chan T, x)中的x
	buf      unsafe.Pointer // 缓冲区地址
	elemsize uint16         // 元素大小，单位为字节
	closed   uint32         //chan关闭标记
	elemtype *_type         // 元素类型
	sendx    uint   // 待发送元素在缓冲器中的索引
	recvx    uint   // 待接收元素在缓冲器中的索引
	recvq    waitq  // 接收等待队列，用于阻塞接收协程
	sendq    waitq  // 发送等待队列，用于阻塞发送协程

	// lock protects all fields in hchan, as well as several
	// fields in sudogs blocked on this channel.
	//
	// Do not change another G's status while holding this lock
	// (in particular, do not ready a G), as this can deadlock
	// with stack shrinking.
	lock mutex  //自旋锁
}
```

看这个头文件，感觉挺轻巧的，就是一个简单的结构体外挂一个queue指针

还有4个函数，就不上源码了

1. makechan:创建一个chan
2. chansend1:给一个chan发送一条消息
3. chanrecv1:从一个chan接收消息
4. closechan:关闭一个管道

可参考图

正常收发就不写了，需要注意的，如下：

closed ：先是打上一个标识，但管道里的值不做清空，释放所有recvq，并存入glist等待唤醒 ，再释放所有sendq，同样存入golist，等待唤醒 ，最后唤醒所有glist里的协程

这里有趣的是：如果是阻塞模式，一但被关闭就被告知不用阻塞了，唯一能做判定的是：读出的值如果是一个类型的默认值即为被关闭了，这个挺模糊的

![image.png](image/image.png)

%E5%85%88%E4%B8%8A%E6%BA%90%E7%A0%81%0A%3Ego%2Fsrc%2Fruntime%2Fchan.go%0A%60%60%60%0Atype%20hchan%20struct%20%7B%0A%09qcount%20%20%20uint%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E9%98%9F%E5%88%97%E4%B8%AD%E7%9A%84%E5%85%83%E7%B4%A0%E6%80%BB%E9%87%8F%0A%09dataqsiz%20uint%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E7%BC%93%E5%86%B2%E5%A4%A7%E5%B0%8F%EF%BC%8C%3Dmake\(chan%20T%2C%20x\)%E4%B8%AD%E7%9A%84x%0A%09buf%20%20%20%20%20%20unsafe.Pointer%20%2F%2F%20%E7%BC%93%E5%86%B2%E5%8C%BA%E5%9C%B0%E5%9D%80%0A%09elemsize%20uint16%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%85%83%E7%B4%A0%E5%A4%A7%E5%B0%8F%EF%BC%8C%E5%8D%95%E4%BD%8D%E4%B8%BA%E5%AD%97%E8%8A%82%0A%09closed%20%20%20uint32%20%20%20%20%20%20%20%20%20%2F%2Fchan%E5%85%B3%E9%97%AD%E6%A0%87%E8%AE%B0%0A%09elemtype%20\*\_type%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%85%83%E7%B4%A0%E7%B1%BB%E5%9E%8B%0A%09sendx%20%20%20%20uint%20%20%20%2F%2F%20%E5%BE%85%E5%8F%91%E9%80%81%E5%85%83%E7%B4%A0%E5%9C%A8%E7%BC%93%E5%86%B2%E5%99%A8%E4%B8%AD%E7%9A%84%E7%B4%A2%E5%BC%95%0A%09recvx%20%20%20%20uint%20%20%20%2F%2F%20%E5%BE%85%E6%8E%A5%E6%94%B6%E5%85%83%E7%B4%A0%E5%9C%A8%E7%BC%93%E5%86%B2%E5%99%A8%E4%B8%AD%E7%9A%84%E7%B4%A2%E5%BC%95%0A%09recvq%20%20%20%20waitq%20%20%2F%2F%20%E6%8E%A5%E6%94%B6%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97%EF%BC%8C%E7%94%A8%E4%BA%8E%E9%98%BB%E5%A1%9E%E6%8E%A5%E6%94%B6%E5%8D%8F%E7%A8%8B%0A%09sendq%20%20%20%20waitq%20%20%2F%2F%20%E5%8F%91%E9%80%81%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97%EF%BC%8C%E7%94%A8%E4%BA%8E%E9%98%BB%E5%A1%9E%E5%8F%91%E9%80%81%E5%8D%8F%E7%A8%8B%0A%0A%09%2F%2F%20lock%20protects%20all%20fields%20in%20hchan%2C%20as%20well%20as%20several%0A%09%2F%2F%20fields%20in%20sudogs%20blocked%20on%20this%20channel.%0A%09%2F%2F%0A%09%2F%2F%20Do%20not%20change%20another%20G's%20status%20while%20holding%20this%20lock%0A%09%2F%2F%20\(in%20particular%2C%20do%20not%20ready%20a%20G\)%2C%20as%20this%20can%20deadlock%0A%09%2F%2F%20with%20stack%20shrinking.%0A%09lock%20mutex%20%20%2F%2F%E8%87%AA%E6%97%8B%E9%94%81%0A%7D%0A%60%60%60%0A%0A%E7%9C%8B%E8%BF%99%E4%B8%AA%E5%A4%B4%E6%96%87%E4%BB%B6%EF%BC%8C%E6%84%9F%E8%A7%89%E6%8C%BA%E8%BD%BB%E5%B7%A7%E7%9A%84%EF%BC%8C%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93%E5%A4%96%E6%8C%82%E4%B8%80%E4%B8%AAqueue%E6%8C%87%E9%92%88%0A%0A%E8%BF%98%E6%9C%894%E4%B8%AA%E5%87%BD%E6%95%B0%EF%BC%8C%E5%B0%B1%E4%B8%8D%E4%B8%8A%E6%BA%90%E7%A0%81%E4%BA%86%0A%0A1.%20makechan%3A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAchan%0A2.%20chansend1%3A%E7%BB%99%E4%B8%80%E4%B8%AAchan%E5%8F%91%E9%80%81%E4%B8%80%E6%9D%A1%E6%B6%88%E6%81%AF%0A3.%20chanrecv1%3A%E4%BB%8E%E4%B8%80%E4%B8%AAchan%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF%0A4.%20closechan%3A%E5%85%B3%E9%97%AD%E4%B8%80%E4%B8%AA%E7%AE%A1%E9%81%93%0A%0A%E5%8F%AF%E5%8F%82%E8%80%83%E5%9B%BE%0A%0A%0A%E6%AD%A3%E5%B8%B8%E6%94%B6%E5%8F%91%E5%B0%B1%E4%B8%8D%E5%86%99%E4%BA%86%EF%BC%8C%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%EF%BC%8C%E5%A6%82%E4%B8%8B%EF%BC%9A%0A%0Aclosed%20%EF%BC%9A%E5%85%88%E6%98%AF%E6%89%93%E4%B8%8A%E4%B8%80%E4%B8%AA%E6%A0%87%E8%AF%86%EF%BC%8C%E4%BD%86%E7%AE%A1%E9%81%93%E9%87%8C%E7%9A%84%E5%80%BC%E4%B8%8D%E5%81%9A%E6%B8%85%E7%A9%BA%EF%BC%8C%E9%87%8A%E6%94%BE%E6%89%80%E6%9C%89recvq%EF%BC%8C%E5%B9%B6%E5%AD%98%E5%85%A5glist%E7%AD%89%E5%BE%85%E5%94%A4%E9%86%92%20%EF%BC%8C%E5%86%8D%E9%87%8A%E6%94%BE%E6%89%80%E6%9C%89sendq%EF%BC%8C%E5%90%8C%E6%A0%B7%E5%AD%98%E5%85%A5golist%EF%BC%8C%E7%AD%89%E5%BE%85%E5%94%A4%E9%86%92%20%EF%BC%8C%E6%9C%80%E5%90%8E%E5%94%A4%E9%86%92%E6%89%80%E6%9C%89glist%E9%87%8C%E7%9A%84%E5%8D%8F%E7%A8%8B%0A%0A%E8%BF%99%E9%87%8C%E6%9C%89%E8%B6%A3%E7%9A%84%E6%98%AF%EF%BC%9A%E5%A6%82%E6%9E%9C%E6%98%AF%E9%98%BB%E5%A1%9E%E6%A8%A1%E5%BC%8F%EF%BC%8C%E4%B8%80%E4%BD%86%E8%A2%AB%E5%85%B3%E9%97%AD%E5%B0%B1%E8%A2%AB%E5%91%8A%E7%9F%A5%E4%B8%8D%E7%94%A8%E9%98%BB%E5%A1%9E%E4%BA%86%EF%BC%8C%E5%94%AF%E4%B8%80%E8%83%BD%E5%81%9A%E5%88%A4%E5%AE%9A%E7%9A%84%E6%98%AF%EF%BC%9A%E8%AF%BB%E5%87%BA%E7%9A%84%E5%80%BC%E5%A6%82%E6%9E%9C%E6%98%AF%E4%B8%80%E4%B8%AA%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC%E5%8D%B3%E4%B8%BA%E8%A2%AB%E5%85%B3%E9%97%AD%E4%BA%86%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%8C%BA%E6%A8%A1%E7%B3%8A%E7%9A%84%0A%0A\!%5Bd8a93d9b9b4e81d37ab188d3e1da39f3.png%5D\(evernotecid%3A%2F%2F48EFC692\-6DE3\-4EEF\-8E65\-DB61EC1E8D7A%2Fappyinxiangcom%2F35868219%2FENResource%2Fp6\)%0A%0A%0A%0A%2F%2F%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%3D%0A%E4%B8%A4%E7%A7%8D%E7%89%B9%E6%AE%8A%E7%9A%84channel%E5%86%85%E5%AE%B9%E7%B1%BB%E5%9E%8B%0A1%E3%80%81nil%0A2%E3%80%81chan%0A%0A%E4%B8%A4%E7%A7%8D%E9%83%BD%E6%B2%A1%E8%AF%95%EF%BC%8C%E7%AC%AC2%E7%A7%8D%20%E6%98%AF%E7%AE%A1%E9%81%93%E4%B8%AD%E7%9A%84%E7%AE%A1%E9%81%93%0A%0Achan%E5%81%9A%E4%B8%BA%E5%8F%82%E6%95%B0%EF%BC%8C%E6%B5%81%E5%90%91%EF%BC%9A%0A%0Afunc%20aaa\(in%20chan\-%3C%20int\)%0A%E5%AE%9A%E4%B9%89%E4%B8%80%E5%87%BD%E6%95%B0%E5%90%8D%E4%B8%BA%EF%BC%9Aaaa%E7%9A%84%E5%87%BD%E6%95%B0%20%2C%20%E5%85%B6%E4%B8%AD%E6%9C%89%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E5%8F%AB%EF%BC%9Ain%EF%BC%8C%E8%AF%A5%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B%E6%98%AF%E4%B8%80%E4%B8%AAchan%E7%AE%A1%E9%81%93%EF%BC%8C%E8%AF%A5%E5%8F%AA%E8%83%BD%E6%8E%A5%E6%94%B6%E7%AE%A1%E9%81%93%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%B8%8D%E5%85%81%E8%AE%B8%E5%86%99%E5%85%A5%E7%AE%A1%E7%90%86%0A%0Afunc%20aaa\(in%20%3C\-chan%20int\)%0A%E5%90%8C%E4%B8%8A%EF%BC%8C%E5%8F%AA%E6%98%AFin%20%E5%8F%82%E6%95%B0%EF%BC%8C%E5%8F%AA%E5%85%81%E8%AE%B8%E5%86%99%E5%85%A5%E7%AE%A1%E7%90%86%EF%BC%8C%E4%B8%8D%E5%85%81%E8%AE%B8%E8%AF%BB%E5%87%BA%0A%0A%E5%85%B3%E9%97%AD%0A%0A%E4%B8%80%E4%B8%AA%E7%AE%A1%E9%81%93%E7%94%A8%E5%AE%8C%EF%BC%8C%E4%B8%8D%E5%85%B3%E9%97%AD%E4%B9%9F%E8%A1%8C%EF%BC%8C%E7%BC%96%E8%AF%91%E5%99%A8%E4%BC%9A%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%0A%E4%B8%BA%E4%BA%86%E7%A8%8B%E5%BA%8F%E7%9A%84%E4%B8%A5%E8%B0%A8%E6%80%A7%EF%BC%8C%E5%B0%BD%E9%87%8F%E8%BF%98%E6%98%AF%E5%85%B3%E9%97%AD%0A%E5%85%B3%E9%97%AD%E7%9A%84%E8%AF%9D%EF%BC%8C%E5%86%99%E6%93%8D%E4%BD%9C%E6%89%8D%E5%85%B3%E9%97%AD%EF%BC%8C%E8%AF%BB%E4%B8%80%E8%88%AC%E4%B8%8D%E9%9C%80%E8%A6%81%E5%85%B3%E9%97%AD%0A%E5%BD%93%E4%B8%80%E4%B8%AA%E7%AE%A1%E9%81%93%E8%A2%AB%E5%85%B3%E9%97%AD%E5%90%8E%EF%BC%8C%E5%86%8D%E5%86%99%E5%85%A5%E5%8D%B3%E4%BC%9A%E6%8A%A5panic%0A%E5%BD%93%E4%B8%80%E4%B8%AA%E7%AE%A1%E9%81%93%E8%A2%AB%E5%85%B3%E9%97%AD%E5%90%8E%EF%BC%8C%E5%86%8D%E8%AF%BB%E5%87%BA%E4%BC%9A%E8%BF%94%E5%9B%9Efalse\(%E6%84%9F%E8%A7%89%E8%A6%81%E6%B1%82%E8%AF%BB%E5%87%BA%E6%93%8D%E4%BD%9C%E5%BF%85%E9%A1%BB%E8%A6%81%E5%A4%9A%E8%AF%BB%E4%B8%80%E4%B8%AAerr%E5%8F%98%E9%87%8F%EF%BC%8C%E5%B9%B6%E5%88%A4%E6%96%AD%EF%BC%8C%E4%BF%9D%E8%AF%81%E7%A8%8B%E5%BA%8F%E4%B8%A5%E8%B0%A8\)%0A%E4%B8%9C%E8%A5%BF%E8%99%BD%E7%84%B6%E5%B0%91%EF%BC%8C%E4%BD%86%E8%83%BD%E5%B9%B2%E7%9A%84%E4%BA%8B%E6%83%85%E6%9C%89%E7%82%B9%E5%A4%9A%EF%BC%9A%0A%0A%E4%B8%8D%E5%B8%A6%E7%BC%93%E5%AD%98%E7%9A%84chan%EF%BC%8C%E6%98%AF%E5%AE%8C%E5%85%A8%E9%98%BB%E5%A1%9E%E7%9A%84%EF%BC%8C%E8%BF%99%E9%87%8C%E5%8F%AF%E4%BB%A5%E7%94%A8%E5%81%9A%E7%AD%89%E5%BE%85%E6%9F%90%E4%B8%AA%E5%8D%8F%E7%A8%8B%E7%BB%93%E6%9D%9F%E5%90%8E%EF%BC%8C%E5%86%8D%E6%89%A7%E8%A1%8C%E4%B8%8B%E9%9D%A2%E7%9A%84%E4%BB%A3%E7%A0%81%0A%E7%AE%97%E6%98%AF%E4%B8%8A%E9%9D%A2%E7%9A%84%E5%8D%87%E7%BA%A7%E7%89%88%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%BF%9E%E6%8E%A5A%20B%20C%20...%20N%E4%B8%AA%E5%8D%8F%E7%A8%8B%E5%87%BD%E6%95%B0%EF%BC%8C%E7%B1%BB%E4%BC%BCshell%E7%9A%84%E5%A4%9A%E6%8C%87%E4%BB%A4%E6%89%A7%E8%A1%8C%0A%E5%B8%A6%E7%BC%93%E5%AD%98%E7%9A%84chan%EF%BC%8C%E6%84%9F%E8%A7%89%E6%9B%B4%E5%83%8F%E6%98%AF%E4%B8%80%E4%B8%AA%E9%98%9F%E5%88%97%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%84%9F%E8%A7%89%E6%8C%BA%E7%A5%9E%E5%A5%87%EF%BC%8C%E7%BC%93%E5%AD%98%E4%BD%8F%E4%BF%A1%E6%81%AF%EF%BC%8C%E7%94%B1%E6%8E%A5%E6%94%B6%E6%96%B9%E5%86%8D%E6%B6%88%E8%B4%B9%EF%BC%8C%E5%B0%B1%E6%98%AF%E4%B8%AA%20%E7%94%9F%E4%BA%A7%E8%80%85%2F%E6%B6%88%E8%B4%B9%E8%80%85%20%E6%A8%A1%E5%9E%8B%0A%E6%84%9F%E8%A7%89chan%E7%89%B9%E5%88%AB%E5%83%8F%E6%98%AF%E4%B8%80%E4%B8%AA%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E9%94%81%EF%BC%8C%E4%BD%86%E6%84%9F%E8%A7%89%E5%AE%83%E6%9B%B4%E5%85%B3%E5%BF%83%E7%9A%84%E6%98%AF%E6%95%B0%E6%8D%AE%E6%B5%81%E5%8A%A8%0A%E8%BF%99%E9%87%8C%E6%9C%80%E4%B8%BA%E5%A5%BD%E5%A5%87%E7%9A%84%E6%98%AF%E7%AC%AC4%E6%9D%A1%EF%BC%8Cchan%20%E4%B8%8E%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E9%94%81%E7%9A%84%E6%9C%AC%E8%B4%A8%E5%8C%BA%E5%88%AB%EF%BC%8C%E6%9F%A5%E4%BA%86%E4%B8%8B%EF%BC%8C%E8%BF%99%E4%B8%AA%E4%B8%9C%E8%A5%BF%E4%B9%9F%E6%98%AFgolang%E6%8F%90%E9%AB%98%E5%B9%B6%E5%8F%91%E7%9A%84%E6%A0%B8%E5%BF%83%0A%0A%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E9%94%81%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%83%B3%E8%A6%81%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97%E7%9A%84%E8%AF%9D%E5%B0%B1%E5%BE%97%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E5%A4%A7%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%8C%E9%87%8C%E9%9D%A2%E8%87%B3%E5%B0%91%E5%BE%97%E6%9C%89%E4%B8%AA%E4%B8%AA%E5%80%BC%EF%BC%9A%201%E3%80%81%E4%B8%80%E4%B8%AA%E5%85%A8%E5%B1%80%E9%94%81%E7%B1%BB%E5%9E%8B%E7%9A%84%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%8F%98%E9%87%8F%0A2%E3%80%81%E4%B8%80%E4%B8%AA%E6%95%B0%E7%BB%84%EF%BC%8C%E7%94%A8%E4%BA%8E%E7%BC%93%E5%AD%98%E4%B8%80%E4%BA%9B%E9%9C%80%E8%A6%81%E5%A4%84%E7%90%86%E7%9A%84%E6%95%B0%E6%8D%AE%0A%0A%E4%BD%BF%E7%94%A8%E4%B8%8A%EF%BC%9A%E5%A4%9A%E5%8D%8F%E7%A8%8B%E8%A6%81%E5%A4%84%E7%90%86%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%BE%97%E5%85%88%E7%94%A81%E5%8F%98%E9%87%8F%E9%94%81%E4%B8%80%E4%B8%8B%EF%BC%8C%E5%A4%84%E7%90%86%E5%AE%8C%E4%BA%86%E5%86%8D%E8%A7%A3%E9%94%81%EF%BC%8C%E4%B8%8B%E4%B8%80%E4%B8%AA%E5%8D%8F%E7%A8%8B%E5%B0%B1%E5%8F%AF%E4%BB%A5%20%E7%94%A8%E4%BA%86%E3%80%82%0A%0A%E5%8D%95%E7%BA%AF%E4%BB%8E%E4%BB%A3%E7%A0%81%E5%A4%8D%E6%9D%82%E5%BA%A6%E4%B8%8A%EF%BC%9A%E5%85%A8%E5%B1%80%E9%94%81%E8%B7%9Fchan%20%E9%83%BD%E5%B7%AE%E4%B8%8D%E5%A4%9A%0A%0A%0A
